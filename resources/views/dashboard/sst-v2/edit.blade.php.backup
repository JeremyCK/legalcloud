@extends('dashboard.base')
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Bootstrap Modal JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Use jQuery 3.6.0 for modal functionality
    var $jq3 = jQuery.noConflict(true);
    
    // Override the global $ and jQuery with version 3.6.0
    window.$ = $jq3;
    window.jQuery = $jq3;
</script>

@section('content')
    <div class="container-fluid">
        <div class="fade-in">

            <div class="row">
                <div class="col-sm-12">

                    <div id="dList" class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-sm-6 col-md-10 col-lg-8 col-xl-6 ">
                                    <h4>Edit SST V2 Records (Invoice Based)</h4>
                                </div>
                                
                                <div class="col-sm-6 col-md-10 col-lg-8 col-xl-6 ">
                                    <a class="btn btn-lg btn-info  float-right" href="{{ route('sst-v2.list') }}">
                                        <i class="cil-arrow-left"> </i>Back to list
                                      </a>
                                </div>
                               
                            </div>
                        </div>
                        <div class="card-body">
                            @if (Session::has('message'))
                                <div class="alert alert-success" role="alert">{{ Session::get('message') }}</div>
                            @endif

                            <form method="POST">
                                @csrf
                                @method('PUT')
                                <div class="row">

                                    <div class="col-sm-6 col-md-10 col-lg-8 col-xl-6 ">
                                        <div class="form-group row">
                                            <label class="col-md-4 col-form-label" for="payment_date">Payment Date</label>
                                            <div class="col-md-8">
                                                <input class="form-control" name="payment_date" id="payment_date"
                                                    value="{{ $SSTMain->payment_date }}" type="date" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6 col-md-10 col-lg-8 col-xl-6 ">
                                        <div class="form-group row">
                                            <label class="col-md-4 col-form-label" for="amount">Total Paid Amount</label>
                                            <div class="col-md-8">
                                                <input class="form-control" name="transfer_amount_hidden"
                                                    value="{{ $SSTMain->amount }}"
                                                    id="transfer_amount_hidden" value="0.00" type="hidden" />
                                                <input class="form-control" name="transfer_amount"
                                                    value="{{ $SSTMain->amount }}" id="transfer_amount"
                                                    value="0.00" type="number" readonly />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6 col-md-10 col-lg-8 col-xl-6 ">
                                        <div class="form-group row">
                                            <label class="col-md-4 col-form-label" for="hf-email">Transaction ID</label>
                                            <div class="col-md-8">
                                                <input class="form-control" name="trx_id" id="trx_id" type="text"
                                                    value="{{ $SSTMain->transaction_id }}" />
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-6 col-md-10 col-lg-8 col-xl-6 ">
                                        <div class="form-group row">
                                            <label class="col-md-4 col-form-label" for="hf-email">Remark</label>
                                            <div class="col-md-8">
                                                <textarea class="form-control" id="remark" name="remark" row="3">{{ $SSTMain->remark }}</textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-sm-12">

                                        <button type="button" class="btn btn-success float-right" onclick="saveSST();">
                                            <i class="fa cil-save"> </i>Save
                                        </button>
                                    </div>

                                    <div class="col-sm-12">
                                        <hr />
                                    </div>

                                </div>

                                <div class="row">
                                    <div class="col-12 ">
                                        <h4>Transferred List</h4>
                                    </div>
                                    <div class="col-12 ">
                                        <hr />
                                    </div>

                                    <div class="col-12 " style="margin-bottom:20px;">

                                        <button type="button" class="btn btn-danger" onclick="deleteTransferSelected();">
                                            <i class="fa cil-x"> </i>Delete selected
                                        </button>

                                    </div>
                                    <div class="col-sm-12">
                                        <table id="tbl-transferred-fee"
                                            class="table table-bordered table-striped yajra-datatable" style="width:100%">
                                            <thead>
                                                <tr>
                                                    <th>No</th>
                                                    <th>Ref No</th>
                                                    <th>Client Name</th>
                                                    <th>Bill No</th>
                                                    <th>Invoice No</th>
                                                    <th>Total amt</th>
                                                    <th>Collected amt</th>
                                                    <th>sst</th>
                                                    <th>Payment Date</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                            
                                            <tfoot style="background-color: black;color:white">
                                                <th colspan="5" class="text-left">Total </th>
                                                <th><span id="span_total_amount">0.00</span></th>
                                                <th><span id="span_collected_amount">0.00</span> </th>
                                                <th><span id="span_total_sst">0.00</span> </th>
                                                <th></th>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>

                            </form>

                            <div class="col-12 ">
                                <hr />
                            </div>

                            <div class="col-12 ">
                                <h4>New transfer list</h4>
                            </div>

                            <div class="col-12 ">
                                <hr />
                            </div>

                            <div class="col-12 " style="margin-bottom:20px;">
                                <button type="button" class="btn btn-danger" onclick="deleteAll();">
                                    <i class="fa cil-x"> </i>Delete all
                                </button>

                                <button type="button" class="btn btn-danger" onclick="deleteSelected();">
                                    <i class="fa cil-x"> </i>Delete selected
                                </button>

                                <button type="button" class="btn btn-info float-right" onclick="openInvoiceModal()">
                                    <i class="fa fa-search"></i> Add New SST Payment
                                </button>
                            </div>

                            <table id="tbl-transfer-bill-added" class="table table-bordered table-striped yajra-datatable"
                                style="width:100%">
                                <thead>
                                    <tr>
                                        <th>No</th>
                                        <th>Ref No</th>
                                        <th>Client Name</th>
                                        <th>Bill No</th>
                                        <th>Invoice No</th>
                                        <th>Total amt</th>
                                        <th>Collected amt</th>
                                        <th>sst</th>
                                        <th>Payment Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

        <!-- Invoice Selection Modal -->
        <div class="modal fade" id="invoiceModal" tabindex="-1" role="dialog" aria-labelledby="invoiceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl" role="document" style="max-width: 99%; width: 99%; margin: 0.25rem auto;">
            <div class="modal-content">
                <div class="modal-header">
        <h5 class="modal-title" id="invoiceModalLabel">
          <i class="fa fa-file-invoice"></i> Select Invoices for SST Transfer
        </h5>
                 <button type="button" class="close" onclick="closeModal()" aria-label="Close">
                   <span aria-hidden="true">&times;</span>
                 </button>
                </div>
                <div class="modal-body">
        <!-- Collapsible Search Filters -->
        <div class="card mb-2">
          <div class="card-header py-2" style="background-color: #f8f9fa; cursor: pointer;" onclick="toggleFilters()">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0" style="font-size: 14px;">
                <i class="fa fa-search"></i> Search & Filter Options
              </h6>
              <span class="badge badge-secondary" id="filterToggleIcon">
                <i class="fa fa-chevron-up"></i>
              </span>
                                </div>
                            </div>
          <div class="card-body py-2" id="filterSection">
            <div class="row mb-2">
          <div class="col-md-3">
            <label for="searchInvoiceNo" style="font-size: 12px; margin-bottom: 2px;">Invoice No:</label>
            <textarea id="searchInvoiceNo" class="form-control" rows="2" style="font-size: 11px;" placeholder="Enter invoice numbers (one per line or comma-separated)&#10;Example:&#10;INV-001&#10;INV-002, INV-003&#10;INV-004"></textarea>
            <small class="text-muted" style="font-size: 10px;">Enter multiple invoice numbers separated by commas or new lines</small>
            <div id="invoiceCount" class="text-info" style="display:none;">
              <small style="font-size: 10px;"><i class="fa fa-info-circle"></i> <span id="invoiceCountText">0</span> invoice numbers entered</small>
                        </div>
            <button type="button" class="btn btn-sm btn-outline-secondary mt-1" style="font-size: 10px; padding: 2px 6px;" onclick="clearInvoiceNumbers()">
              <i class="fa fa-times"></i> Clear Invoice Numbers
            </button>
                                </div>
          <div class="col-md-3">
            <label for="searchCaseRef" style="font-size: 12px; margin-bottom: 2px;">Case Ref No:</label>
            <input type="text" id="searchCaseRef" class="form-control" style="font-size: 11px;" placeholder="Search case ref...">
          </div>
          <div class="col-md-3">
            <label for="searchClient" style="font-size: 12px; margin-bottom: 2px;">Client Name:</label>
            <input type="text" id="searchClient" class="form-control" style="font-size: 11px;" placeholder="Search client...">
          </div>
          <div class="col-md-3">
            <label for="searchBillingParty" style="font-size: 12px; margin-bottom: 2px;">Billing Party:</label>
            <input type="text" id="searchBillingParty" class="form-control" style="font-size: 11px;" placeholder="Search billing party...">
                            </div>
                        </div>

        <!-- Additional Filters -->
        <div class="row mb-2">
          <div class="col-md-3">
            <label for="filterBranch" style="font-size: 12px; margin-bottom: 2px;">Branch:</label>
            <select id="filterBranch" class="form-control" style="font-size: 11px;">
              <option value="">-- All Branches --</option>
              @foreach($Branchs as $branch)
                                            <option value="{{ $branch->id }}">{{ $branch->name }}</option>
                                        @endforeach
                                    </select>
                                </div>
          <div class="col-md-3">
            <label for="filterStartDate" style="font-size: 12px; margin-bottom: 2px;">Start Date:</label>
            <input type="date" id="filterStartDate" class="form-control" style="font-size: 11px;">
          </div>
          <div class="col-md-3">
            <label for="filterEndDate" style="font-size: 12px; margin-bottom: 2px;">End Date:</label>
            <input type="date" id="filterEndDate" class="form-control" style="font-size: 11px;">
          </div>
          <div class="col-md-3">
            <label style="font-size: 12px; margin-bottom: 2px;">&nbsp;</label>
            <div>
              <button type="button" class="btn btn-sm btn-outline-secondary" style="font-size: 10px; padding: 2px 6px;" onclick="clearDateFilters()">
                <i class="fa fa-times"></i> Clear Dates
              </button>
            </div>
                            </div>
                        </div> 

                 <div class="row mb-2">
           <div class="col-md-6">
             <label for="perPageSelect" style="font-size: 12px; margin-bottom: 2px;">Records per page:</label>
             <select id="perPageSelect" class="form-control" style="width: auto; display: inline-block; font-size: 11px;">
               <option value="10">10 records</option>
               <option value="20" selected>20 records</option>
               <option value="50">50 records</option>
               <option value="100">100 records</option>
             </select>
             <small class="text-muted" style="font-size: 10px;">Changing this will refresh the list</small>
           </div>
           <div class="col-md-6 text-right">
             <button type="button" class="btn btn-primary btn-sm" style="font-size: 11px; padding: 4px 8px;" onclick="searchInvoices()">
               <i class="fa fa-search"></i> Search
             </button>
             <button type="button" class="btn btn-secondary btn-sm" style="font-size: 11px; padding: 4px 8px;" onclick="clearSearch()">
               <i class="fa fa-times"></i> Clear
             </button>
           </div>
         </div>
       </div>
     </div>

        <!-- Quick Search Bar -->
        <div class="row mb-2">
          <div class="col-md-12">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text"><i class="fa fa-search"></i></span>
              </div>
              <input type="text" id="quickSearch" class="form-control" placeholder="Quick search across all fields..." style="font-size: 12px;">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary" type="button" onclick="clearQuickSearch()" style="font-size: 11px;">
                  <i class="fa fa-times"></i> Clear
                </button>
              </div>
            </div>
          </div>
                        </div>

        <!-- Selection Controls -->
        <div class="row mb-2">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
              <label class="form-check-label" for="selectAll" style="font-size: 12px;">
                <strong>Select All Visible</strong>
              </label>
            </div>
          </div>
          <div class="col-md-6 text-right">
            <span class="badge badge-info" id="selectedCount" style="font-size: 11px;">0 selected</span>
          </div>
                    </div>

        <!-- Invoice List Container -->
        <div id="invoiceListContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem;">
          <div class="text-center p-3" id="loadingIndicator" style="display: none;">
            <i class="fa fa-spinner fa-spin"></i> Loading invoices...
                </div>
          <div id="invoiceListContent">
            <!-- Invoice list will be loaded here -->
                        </div>
        </div>

        <!-- Pagination -->
        <div class="row mt-2">
          <div class="col-md-6">
            <div id="paginationInfo" class="text-muted" style="font-size: 11px;">
              <!-- Pagination info will be displayed here -->
            </div>
          </div>
          <div class="col-md-6">
            <div id="paginationControls" class="text-right">
              <!-- Pagination controls will be displayed here -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">
          <i class="fa fa-times"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="confirmInvoiceSelection()">
          <i class="fa fa-check"></i> Add Selected Invoices
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Selection Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1" role="dialog" aria-labelledby="invoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document" style="max-width: 99%; width: 99%; margin: 0.25rem auto;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invoiceModalLabel">
                        <i class="fa fa-file-invoice"></i> Select Invoices for SST Transfer
                    </h5>
                    <button type="button" class="close" onclick="closeModal()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Collapsible Search Filters -->
                    <div class="card mb-2">
                        <div class="card-header py-2" style="background-color: #f8f9fa; cursor: pointer;" onclick="toggleFilters()">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" style="font-size: 14px;">
                                    <i class="fa fa-search"></i> Search & Filter Options
                                </h6>
                                <span class="badge badge-secondary" id="filterToggleIcon">
                                    <i class="fa fa-chevron-up"></i>
                                </span>
                            </div>
                        </div>
                        <div class="card-body py-2" id="filterSection">
                            <div class="row mb-2">
                                <div class="col-md-3">
                                    <label for="searchInvoiceNo" style="font-size: 12px; margin-bottom: 2px;">Invoice No:</label>
                                    <textarea id="searchInvoiceNo" class="form-control" rows="2" style="font-size: 11px;" placeholder="Enter invoice numbers (one per line or comma-separated)&#10;Example:&#10;INV-001&#10;INV-002, INV-003&#10;INV-004"></textarea>
                                    <small class="text-muted" style="font-size: 10px;">Enter multiple invoice numbers separated by commas or new lines</small>
                                    <div id="invoiceCount" class="text-info" style="display:none;">
                                        <small style="font-size: 10px;"><i class="fa fa-info-circle"></i> <span id="invoiceCountText">0</span> invoice numbers entered</small>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" style="font-size: 10px; padding: 2px 6px;" onclick="clearInvoiceNumbers()">
                                        <i class="fa fa-times"></i> Clear Invoice Numbers
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <label for="searchCaseRef" style="font-size: 12px; margin-bottom: 2px;">Case Ref No:</label>
                                    <input type="text" id="searchCaseRef" class="form-control" style="font-size: 11px;" placeholder="Search case ref...">
                                </div>
                                <div class="col-md-3">
                                    <label for="searchClient" style="font-size: 12px; margin-bottom: 2px;">Client Name:</label>
                                    <input type="text" id="searchClient" class="form-control" style="font-size: 11px;" placeholder="Search client...">
                                </div>
                                <div class="col-md-3">
                                    <label for="searchBillingParty" style="font-size: 12px; margin-bottom: 2px;">Billing Party:</label>
                                    <input type="text" id="searchBillingParty" class="form-control" style="font-size: 11px;" placeholder="Search billing party...">
                                </div>
                            </div>
                            
                            <!-- Additional Filters -->
                            <div class="row mb-2">
                                <div class="col-md-3">
                                    <label for="filterBranch" style="font-size: 12px; margin-bottom: 2px;">Branch:</label>
                                    <select id="filterBranch" class="form-control" style="font-size: 11px;">
                                        <option value="">-- All Branches --</option>
                                        @foreach($Branchs as $branch)
                                            <option value="{{ $branch->id }}">{{ $branch->name }}</option>
                                        @endforeach
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filterStartDate" style="font-size: 12px; margin-bottom: 2px;">Start Date:</label>
                                    <input type="date" id="filterStartDate" class="form-control" style="font-size: 11px;">
                                </div>
                                <div class="col-md-3">
                                    <label for="filterEndDate" style="font-size: 12px; margin-bottom: 2px;">End Date:</label>
                                    <input type="date" id="filterEndDate" class="form-control" style="font-size: 11px;">
                                </div>
                                <div class="col-md-3">
                                    <label style="font-size: 12px; margin-bottom: 2px;">&nbsp;</label>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" style="font-size: 10px; padding: 2px 6px;" onclick="clearDateFilters()">
                                            <i class="fa fa-times"></i> Clear Dates
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label for="perPageSelect" style="font-size: 12px; margin-bottom: 2px;">Records per page:</label>
                                    <select id="perPageSelect" class="form-control" style="width: auto; display: inline-block; font-size: 11px;">
                                        <option value="10">10 records</option>
                                        <option value="20" selected>20 records</option>
                                        <option value="50">50 records</option>
                                        <option value="100">100 records</option>
                                    </select>
                                    <small class="text-muted" style="font-size: 10px;">Changing this will refresh the list</small>
                                </div>
                                <div class="col-md-6 text-right">
                                    <button type="button" class="btn btn-primary btn-sm" style="font-size: 11px; padding: 4px 8px;" onclick="searchInvoices()">
                                        <i class="fa fa-search"></i> Search
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" style="font-size: 11px; padding: 4px 8px;" onclick="clearSearch()">
                                        <i class="fa fa-times"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="invoiceLoading" style="display:none;" class="text-center">
                        <i class="fa fa-spinner fa-spin fa-2x"></i>
                        <p>Loading invoices...</p>
                    </div>
                    
                    <!-- Quick Search Box -->
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" style="font-size: 12px;">
                                                <i class="fa fa-search"></i>
                                            </span>
                                        </div>
                                        <input type="text" id="quickSearch" class="form-control" style="font-size: 12px;" placeholder="Quick search by Invoice No or Case Ref No..." onkeyup="quickSearch()">
                                        <div class="input-group-append">
                                            <button type="button" class="btn btn-outline-secondary" style="font-size: 12px;" onclick="clearQuickSearch()">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <small class="text-muted" style="font-size: 10px;">Type to filter table rows instantly</small>
                                </div>
                                <div class="col-md-6 text-right">
                                    <span class="badge badge-info" id="quickSearchCount" style="display:none;">
                                        <span id="quickSearchResultCount">0</span> of <span id="quickSearchTotalCount">0</span> records
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="invoiceListContainer">
                        <!-- Invoice list will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="row w-100">
                        <div class="col-md-8 text-left">
                            <div class="d-flex align-items-center">
                                <span class="badge badge-info mr-2">
                                    <span id="modalSelectedCount">0</span> invoices
                                </span>
                                <span class="badge badge-success mr-2">
                                    Total: <span id="modalTotalAmount">0.00</span>
                                </span>
                                <small class="text-muted">
                                    (Scroll to see more invoices)
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-right">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="confirmInvoiceSelection()">
                                <i class="fa fa-check"></i> Confirm Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
@endsection

@section('javascript')
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script>
        // Global variables
        var selectedInvoices = [];
        var currentPage = 1;
        var perPage = 20;
        var totalPages = 1;
        var totalCount = 0;
        var transfer_fee_add_list = [];
        var transfer_fee_delete_list = [];

        $(document).ready(function() {
            // Initialize the page
            updateSelectedInvoicesSummary();
            
            // Load existing SST details into transfer_fee_add_list
            loadExistingSSTDetails();
            
            // Set up event listeners
            $('#perPageSelect').on('change', function() {
                perPage = parseInt($(this).val());
                currentPage = 1;
                searchInvoices();
            });

            // Quick search functionality
            $('#quickSearch').on('input', function() {
                clearTimeout(window.quickSearchTimeout);
                window.quickSearchTimeout = setTimeout(function() {
                    quickSearch();
                }, 300);
            });

            // Invoice number input tracking
            $('#searchInvoiceNo').on('input', function() {
                const value = $(this).val().trim();
                if (value) {
                    const lines = value.split(/[,\n\r]+/).filter(line => line.trim());
                    $('#invoiceCountText').text(lines.length);
                    $('#invoiceCount').show();
                } else {
                    $('#invoiceCount').hide();
                }
            });
        });

        // Modal functions
        function openInvoiceModal() {
            $jq3('#invoiceModal').modal('show');
            // Load invoices immediately when modal opens
            setTimeout(function() {
                searchInvoices();
            }, 500);
        }

        function closeModal() {
            $jq3('#invoiceModal').modal('hide');
        }

        function toggleFilters() {
            const filterSection = $('#filterSection');
            const icon = $('#filterToggleIcon i');
            
            if (filterSection.is(':visible')) {
                filterSection.slideUp();
                icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                filterSection.slideDown();
                icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        }

        // Search and filter functions
        function searchInvoices() {
            // Check if modal elements exist
            if ($('#invoiceListContainer').length === 0) {
                console.log('Modal not ready, skipping search');
                return;
            }
            
            showLoading();
            
            const searchParams = {
                search_invoice_no: $('#searchInvoiceNo').val() || '',
                search_case_ref: $('#searchCaseRef').val() || '',
                search_client: $('#searchClient').val() || '',
                search_billing_party: $('#searchBillingParty').val() || '',
                filter_branch: $('#filterBranch').val() || '',
                filter_start_date: $('#filterStartDate').val() || '',
                filter_end_date: $('#filterEndDate').val() || '',
                page: currentPage,
                per_page: perPage
            };

            $.ajax({
                url: "{{ route('sst-v2.invoice-list') }}",
                type: 'GET',
                data: searchParams,
                success: function(response) {
                    if (response.status === 1) {
                        displayInvoiceList(response.invoiceList);
                        updatePagination(response);
                    } else {
                        showError('Error loading invoices: ' + (response.message || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', error);
                    showError('Error loading invoices: ' + error);
                },
                complete: function() {
                    hideLoading();
                }
            });
        }

        function quickSearch() {
            const searchTerm = $('#quickSearch').val().toLowerCase();
            
            if (searchTerm === '') {
                $('.invoice-row').show();
            } else {
                $('.invoice-row').each(function() {
                    const rowText = $(this).text().toLowerCase();
                    if (rowText.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }
            
            updateSelectAllCheckbox();
        }

        function clearSearch() {
            $('#searchInvoiceNo').val('');
            $('#searchCaseRef').val('');
            $('#searchClient').val('');
            $('#searchBillingParty').val('');
            $('#filterBranch').val('');
            $('#filterStartDate').val('');
            $('#filterEndDate').val('');
            $('#quickSearch').val('');
            $('#invoiceCount').hide();
            
            currentPage = 1;
            searchInvoices();
        }

        function clearInvoiceNumbers() {
            $('#searchInvoiceNo').val('');
            $('#invoiceCount').hide();
        }

        function clearDateFilters() {
            $('#filterStartDate').val('');
            $('#filterEndDate').val('');
        }

        function clearQuickSearch() {
            $('#quickSearch').val('');
            $('.invoice-row').show();
            updateSelectAllCheckbox();
        }

        // Display functions
        function displayInvoiceList(html) {
            if ($('#invoiceListContent').length > 0) {
                $('#invoiceListContent').html(html);
                updateSelectAllCheckbox();
            }
        }

        function showLoading() {
            if ($('#loadingIndicator').length > 0) {
                $('#loadingIndicator').show();
            }
            if ($('#invoiceListContent').length > 0) {
                $('#invoiceListContent').hide();
            }
        }

        function hideLoading() {
            if ($('#loadingIndicator').length > 0) {
                $('#loadingIndicator').hide();
            }
            if ($('#invoiceListContent').length > 0) {
                $('#invoiceListContent').show();
            }
        }

        function showError(message) {
            if ($('#invoiceListContent').length > 0) {
                $('#invoiceListContent').html('<div class="alert alert-danger">' + message + '</div>');
            }
        }

        function updatePagination(response) {
            currentPage = response.currentPage;
            totalPages = response.totalPages;
            totalCount = response.totalCount;
            
            if ($('#paginationInfo').length > 0) {
                $('#paginationInfo').html(`Showing ${((currentPage - 1) * perPage) + 1} to ${Math.min(currentPage * perPage, totalCount)} of ${totalCount} entries`);
            }
            
            let paginationHtml = '';
            if (totalPages > 1) {
                paginationHtml += '<nav><ul class="pagination pagination-sm">';
                
                // Previous button
                if (currentPage > 1) {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">Previous</a></li>`;
                }
                
                // Page numbers
                const startPage = Math.max(1, currentPage - 2);
                const endPage = Math.min(totalPages, currentPage + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    const activeClass = i === currentPage ? 'active' : '';
                    paginationHtml += `<li class="page-item ${activeClass}"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
                }
                
                // Next button
                if (currentPage < totalPages) {
                    paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">Next</a></li>`;
                }
                
                paginationHtml += '</ul></nav>';
            }
            
            if ($('#paginationControls').length > 0) {
                $('#paginationControls').html(paginationHtml);
            }
        }

        function goToPage(page) {
            currentPage = page;
            searchInvoices();
        }

        // Selection functions
        function toggleSelectAll() {
            const selectAll = $('#selectAll').is(':checked');
            $('.invoice-checkbox:visible').prop('checked', selectAll);
            updateSelectedCount();
        }

        function updateSelectAllCheckbox() {
            const visibleCheckboxes = $('.invoice-checkbox:visible');
            const checkedVisibleCheckboxes = visibleCheckboxes.filter(':checked');
            
            if ($('#selectAll').length > 0) {
                if (visibleCheckboxes.length > 0 && visibleCheckboxes.length === checkedVisibleCheckboxes.length) {
                    $('#selectAll').prop('checked', true);
                } else {
                    $('#selectAll').prop('checked', false);
                }
            }
        }

        function updateSelectedCount() {
            const checkedCount = $('.invoice-checkbox:checked').length;
            if ($('#selectedCount').length > 0) {
                $('#selectedCount').text(checkedCount + ' selected');
            }
        }

        // Invoice selection functions
        function confirmInvoiceSelection() {
            let newSelections = [];
            
            $('.invoice-checkbox:checked').each(function() {
                const invoiceId = $(this).val();
                const billId = $(this).data('bill-id');
                const sstAmount = parseFloat($(this).data('sst')) || 0;
                
                // Check if this invoice is already selected
                const existingIndex = selectedInvoices.findIndex(invoice => invoice.id == invoiceId);
                
                if (existingIndex === -1) {
                    // Get invoice details from the table row
                    const row = $(this).closest('tr');
                    const invoiceNo = row.find('td:eq(3)').text() || 'N/A';
                    const invoiceDate = row.find('td:eq(4)').text() || 'N/A';
                    const caseRef = row.find('td:eq(2) a').text() || row.find('td:eq(2)').text() || 'N/A';
                    const clientName = row.find('td:eq(2) a').text() || row.find('td:eq(2)').text() || 'N/A';
                    const paymentDate = row.find('td:eq(8)').text() || 'N/A';
                    const caseId = row.find('td:eq(2) a').attr('href') ? row.find('td:eq(2) a').attr('href').split('/').pop() : null;
                    
                    newSelections.push({
                        id: invoiceId,
                        bill_id: billId,
                        sst_amount: sstAmount,
                        invoice_no: invoiceNo,
                        invoice_date: invoiceDate,
                        case_ref: caseRef,
                        client_name: clientName,
                        payment_date: paymentDate,
                        case_id: caseId
                    });
                }
            });
            
            // Add new selections to the main array
            selectedInvoices = selectedInvoices.concat(newSelections);
            
            // Update the display
            updateSelectedInvoicesSummary();
            closeModal();
        }

        function updateSelectedInvoicesSummary() {
            if (selectedInvoices.length > 0) {
                if ($('#selectedInvoicesSummary').length > 0) {
                    $('#selectedInvoicesSummary').show();
                }
                if ($('#selectedCount').length > 0) {
                    $('#selectedCount').text(selectedInvoices.length);
                }
                
                let totalSstAmount = 0;
                selectedInvoices.forEach(invoice => {
                    totalSstAmount += parseFloat(invoice.sst_amount) || 0;
                });
                
                if ($('#selectedTotalAmount').length > 0) {
                    $('#selectedTotalAmount').text(totalSstAmount.toFixed(2));
                }
                if ($('#pay_amount').length > 0) {
                    $('#pay_amount').val(totalSstAmount.toFixed(2));
                }
                
                // Update the selected invoices table
                updateSelectedInvoicesTable();
            } else {
                if ($('#selectedInvoicesSummary').length > 0) {
                    $('#selectedInvoicesSummary').hide();
                }
                if ($('#pay_amount').length > 0) {
                    $('#pay_amount').val('0.00');
                }
            }
        }

        function updateSelectedInvoicesTable() {
            if ($('#selectedInvoicesTable').length > 0) {
                let tableHtml = '<table class="table table-bordered table-striped" style="margin-bottom: 0;">';
                tableHtml += '<thead class="thead-dark"><tr>';
                tableHtml += '<th>No</th><th>Ref No</th><th>Client Name</th><th>Invoice No</th><th>Invoice Date</th><th>Total amt</th><th>Collected amt</th><th>SST</th><th>Payment Date</th><th>Action</th>';
                tableHtml += '</tr></thead><tbody>';
                
                selectedInvoices.forEach((invoice, index) => {
                    tableHtml += '<tr>';
                    tableHtml += `<td>${index + 1}</td>`;
                    tableHtml += `<td>${invoice.case_ref}</td>`;
                    tableHtml += `<td>${invoice.client_name}</td>`;
                    tableHtml += `<td>${invoice.invoice_no}</td>`;
                    tableHtml += `<td>${invoice.invoice_date}</td>`;
                    tableHtml += `<td class="text-right">0.00</td>`;
                    tableHtml += `<td class="text-right">0.00</td>`;
                    tableHtml += `<td class="text-right">${parseFloat(invoice.sst_amount).toFixed(2)}</td>`;
                    tableHtml += `<td>${invoice.payment_date}</td>`;
                    tableHtml += `<td><button class="btn btn-sm btn-danger" onclick="removeSelectedInvoice(${index})"><i class="fa fa-times"></i></button></td>`;
                    tableHtml += '</tr>';
                });
                
                tableHtml += '</tbody></table>';
                $('#selectedInvoicesTable').html(tableHtml).show();
            }
        }

        function removeSelectedInvoice(index) {
            selectedInvoices.splice(index, 1);
            updateSelectedInvoicesSummary();
        }

        function deleteAll() {
            Swal.fire({
                icon: 'warning',
                text: 'Delete all payments?',
                showCancelButton: true,
                confirmButtonText: `Yes`,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
            }).then((result) => {
                if (result.isConfirmed) {
                    transfer_fee_add_list = [];
                    reloadAddTable();
                    reloadTable();
                }
            })
        }

        function deleteSelected() {
            Swal.fire({
                icon: 'warning',
                text: 'Delete selected payments?',
                showCancelButton: true,
                confirmButtonText: `Yes`,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
            }).then((result) => {
                if (result.isConfirmed) {
                    transfer_fee_add_list = [];
                    $.each($("input[name='add_bill']:not(:checked)"), function() {
                        itemID = $(this).val();
                        bill = {
                            id: itemID,
                        };
                        transfer_fee_add_list.push(bill);
                    })

                    console.log(transfer_fee_add_list);
                    reloadAddTable();
                    reloadTable();
                }
            })
        }

        function deleteTransferSelected() {
            Swal.fire({
                icon: 'warning',
                text: 'Delete selected payments?',
                showCancelButton: true,
                confirmButtonText: `Yes`,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
            }).then((result) => {
                if (result.isConfirmed) {
                    transfer_fee_add_list = [];
                    $.each($("input[name='trans_bill']:not(:checked)"), function() {
                        itemID = $(this).val();
                        bill = {
                            id: itemID,
                        };
                        transfer_fee_add_list.push(bill);
                    })

                    transfer_fee_delete_list = [];

                    $.each($("input[name='trans_bill']:checked"), function() {
                        itemID = $(this).val();
                        bill = {
                            id: itemID,
                        };
                        transfer_fee_delete_list.push(bill);
                    })

                    var form_data = new FormData();
                    form_data.append("delete_bill", JSON.stringify(transfer_fee_delete_list));

                    $.ajax({
                        type: 'POST',
                        url: '/deleteSSTV2/{{ $SSTMain->id }}',
                        data: form_data,
                        processData: false,
                        contentType: false,
                        success: function(result) {
                            console.log(result);
                            if (result.status == 1) {

                                Swal.fire(
                                    'Success!', 'Record deleted',
                                    'success'
                                )

                                location.reload();

                            } else {
                                // Swal.fire('notice!', result.message, 'warning');
                            }
                        }
                    });

                    console.log(transfer_fee_delete_list);

                }
            })
        }

        function saveSST() {

            var voucher_list = [];
            var voucher = {};

            if ($("#trx_id").val() == '' || $("#payment_date").val() == '') {

                Swal.fire({
                    icon: 'warning',
                    text: 'Please make sure all mandatory fields fill',
                    confirmButtonText: `Yes`,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                });
                return;
            }

            $test = 0;

            $.each($("input[name='add_bill']"), function() {
                itemID = $(this).val();
                value = $("#selected_amt_" + itemID).val();
                $test += value;
                voucher = {
                    id: itemID,
                    value: value,
                };

                voucher_list.push(voucher);
            })

            var form_data = new FormData();
            form_data.append("add_bill", JSON.stringify(voucher_list));
            form_data.append("trx_id", $("#trx_id").val());
            form_data.append("payment_date", $("#payment_date").val());
            form_data.append("remark", $("#remark").val());

            $.ajax({
                type: 'POST',
                url: '/updateSSTV2/{{ $SSTMain->id }}',
                data: form_data,
                processData: false,
                contentType: false,
                success: function(result) {
                    console.log(result);
                    if (result.status == 1) {

                        Swal.fire(
                            'Success!', 'Record created',
                            'success'
                        )

                        location.reload();

                        $("#transfer_amount").val(result.total_amount);

                    } else {
                        // Swal.fire('notice!', result.message, 'warning');
                    }
                }
            });
        }

        function numberWithCommas(x) {
            return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Load existing SST details for editing
        function loadExistingSSTDetails() {
            console.log('Loading existing SST details for ID: {{ $SSTMain->id }}');
            
            // Initialize with existing SST details from the server
            @php
                $existingSSTDetails = \App\Models\SSTDetails::where('sst_main_id', $SSTMain->id)->get();
            @endphp
            
            transfer_fee_add_list = [];
            
            @foreach($existingSSTDetails as $detail)
                @if($detail->loan_case_invoice_main_id)
                    transfer_fee_add_list.push({
                        id: {{ $detail->loan_case_invoice_main_id }},
                        value: {{ $detail->amount }}
                    });
                @endif
            @endforeach
            
            console.log('Loaded existing SST details:', transfer_fee_add_list);
            
            // Reload tables to show the data
            reloadAddTable();
            reloadTable();
        }

        function AddIntoTransferList() {
            $.each($("input[name='bill']:checked"), function() {
                itemID = $(this).val();

                bill = {
                    id: itemID,
                };
                transfer_fee_add_list.push(bill);
            })

            console.log(transfer_fee_add_list);
            reloadAddTable();
            reloadTable();
            closeUniversalModal();
        }

        function reloadTransferredTable() {
            var table = $('#tbl-transferred-fee').DataTable({
                processing: true,
                serverSide: true,
                pageLength: 500,
                destroy: true,
                ajax: {
                    url: "{{ route('sst-v2.invoice-list') }}",
                    data: function(d) {
                        d.transfer_list = JSON.stringify(transfer_fee_add_list);
                        d.type = 'transferred';
                        d.transaction_id = {{ $SSTMain->id }};
                    },
                },
                columns: [{
                        data: 'action',
                        className: 'text-center',
                        name: 'action'
                    },
                    {
                        data: 'case_ref_no',
                        name: 'case_ref_no'
                    },
                    {
                        data: 'client_name',
                        name: 'client_name'
                    },
                    {
                        data: 'bill_invoice_no',
                        name: 'bill_invoice_no'
                    },
                    {
                        data: 'invoice_no',
                        name: 'invoice_no'
                    },
                    {
                        data: 'total_amt_inv',
                        name: 'total_amt_inv',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'collected_amt',
                        name: 'collected_amt',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'sst_inv',
                        name: 'sst_inv',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'payment_receipt_date',
                        name: 'payment_receipt_date'
                    },
                ],
                drawCallback: function(settings) {

                    var api = this.api(),
                        data;

                    var intVal = function(i) {
                        return typeof i === 'string' ?
                            i.replace(/[\$,]/g, '') * 1 :
                            typeof i === 'number' ?
                            i : 0;
                    };

                    var span_total_amount = api.column(5).data().reduce(function(a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);
                    var span_collected_amount = api.column(6).data().reduce(function(a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);
                    var span_total_sst = api.column(7).data().reduce(function(a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);

                    $("#span_total_amount").html(numberWithCommas(span_total_amount.toFixed(2)));
                    $("#span_collected_amount").html(numberWithCommas(span_collected_amount.toFixed(2)));
                    $("#span_total_sst").html(numberWithCommas(span_total_sst.toFixed(2)));

                    console.log(span_total_amount);

                }
            });

        }

        function reloadTable() {
            var table = $('#tbl-transfer-bill').DataTable({
                processing: true,
                serverSide: true,
                pageLength: 500,
                destroy: true,
                ajax: {
                    url: "{{ route('sst-v2.invoice-list') }}",
                    data: function(d) {
                        d.transfer_list = JSON.stringify(transfer_fee_add_list);
                        d.type = 'not_transfer';
                        d.recv_start_date = $("#recv_start_date").val();
                        d.recv_end_date = $("#recv_end_date").val();
                        d.branch = $("#branch").val();
                    },
                },
                columns: [{
                        data: 'action',
                        className: 'text-center',
                        name: 'action'
                    },
                    {
                        data: 'case_ref_no',
                        name: 'case_ref_no'
                    },
                    {
                        data: 'client_name',
                        name: 'client_name'
                    },
                    {
                        data: 'bill_invoice_no',
                        name: 'bill_invoice_no'
                    },
                    {
                        data: 'invoice_no',
                        name: 'invoice_no'
                    },
                    {
                        data: 'total_amt_inv',
                        name: 'total_amt_inv',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'collected_amt',
                        name: 'collected_amt',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'sst_inv',
                        name: 'sst_inv',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'payment_receipt_date',
                        name: 'payment_receipt_date'
                    },
                ]
            });

        }

        function reloadAddTable() {
            var table = $('#tbl-transfer-bill-added').DataTable({
                processing: true,
                serverSide: true,
                pageLength: 500,
                destroy: true,
                ajax: {
                    url: "{{ route('sst-v2.invoice-add-list') }}",
                    data: function(d) {
                        d.transfer_list = JSON.stringify(transfer_fee_add_list);
                        d.type = 'add';
                    },
                },
                columns: [{
                        data: 'action',
                        className: 'text-center',
                        name: 'action'
                    },
                    {
                        data: 'case_ref_no',
                        name: 'case_ref_no'
                    },
                    {
                        data: 'client_name',
                        name: 'client_name'
                    },
                    {
                        data: 'bill_invoice_no',
                        name: 'bill_invoice_no'
                    },
                    {
                        data: 'invoice_no',
                        name: 'invoice_no'
                    },
                    {
                        data: 'total_amt_inv',
                        name: 'total_amt_inv',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'collected_amt',
                        name: 'collected_amt',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'sst_inv',
                        name: 'sst_inv',
                        class: 'text-right',
                        render: $.fn.dataTable.render.number(',', '.', 2)
                    },
                    {
                        data: 'payment_receipt_date',
                        name: 'payment_receipt_date'
                    },
                ],
                drawCallback: function(settings) {

                    var api = this.api(),
                        data;

                    var intVal = function(i) {
                        return typeof i === 'string' ?
                            i.replace(/[\$,]/g, '') * 1 :
                            typeof i === 'number' ?
                            i : 0;
                    };

                    var monTotal = api
                        .column(7)
                        .data()
                        .reduce(function(a, b) {
                            return intVal(a) + intVal(b);
                        }, 0);

                    console.log(monTotal);

                    transfer_amt_hidden = parseFloat($("#transfer_amount_hidden").val());
                    console.log(transfer_amt_hidden);

                    transfer_amount = monTotal + transfer_amt_hidden;
                    $("#transfer_amount").val(transfer_amount);
                }
            });

        }

    </script>
@endsection

